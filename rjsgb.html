<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RJS Game Boy WebGL</title>
  <style>
    body { background:#111; margin:0; display:flex; align-items:center; justify-content:center; height:100vh; }
    canvas { image-rendering: pixelated; border:1px solid #444; }
  </style>
</head>
<body>
  <canvas id="gb"></canvas>
  <div id="debugPanel">
    <canvas id="vramView"></canvas>
    <canvas id="paletteView" width="200" height="60"></canvas>
    <button id="refreshDebug">Refresh VRAM / Palette</button>
  </div>
  <br/>
  <div id="loadRomPanel">  
  <br />
    <input type="file" id="romFile" accept=".gb,.gbc" />
  <br />
    <button id="loadRomBtn">Load ROM</button>
 </div>
	<script src="rjs-compiler.js"></script>
<script>
  let emu = null;

  // โหลด CPU → APU → WebGL
  RJS.load("gb_emu_cpu.rjs")
    .then(() => RJS.load("gb_emu_apu.rjs"))
    .then(() => RJS.load("gb_emu_webgl.rjs"))
    .then(() => {
      emu = createGbEmu("gb");
      window._gb = emu;

      // default: ลองโหลด tetris.gb ถ้ามี
      return emu.loadRomFromUrl("tetris.gb");
    })
    .then(() => {
      if (emu) emu.start();
    })
    .catch((err) => {
      console.error("GBEmu init error:", err);
    });


  // ปุ่ม Refresh VRAM / Palette เดิม
  document.getElementById("refreshDebug").addEventListener("click", () => {
    if (window._gb) {
      _gb.debugDrawVramTiles("vramView");
      _gb.debugDrawPalettes("paletteView");
    }
  });

  // --- Loader จากไฟล์ .gb / .gbc ---
  const romInput = document.getElementById("romFile");
  const loadBtn  = document.getElementById("loadRomBtn");

  loadBtn.addEventListener("click", () => {
    if (!window._gb) {
      alert("Emulator ยังไม่พร้อม");
      return;
    }
    if (!romInput.files || !romInput.files[0]) {
      alert("เลือกไฟล์ ROM (.gb / .gbc) ก่อน");
      return;
    }

    const file = romInput.files[0];
    const reader = new FileReader();

    reader.onload = (ev) => {
      const buf = ev.target.result;
      // หยุดของเก่าก่อน กันเฟรมค้าง
      _gb.stop && _gb.stop();

      // loadRomFromArrayBuffer ใน GBEmu ใช้อยู่แล้ว
      _gb.loadRomFromArrayBuffer(buf);
	  // ปลดล็อค AudioContext จาก user click
      _gb.resumeAudio && _gb.resumeAudio();
      _gb.start && _gb.start();
    };

    reader.readAsArrayBuffer(file);
  });
  
  
  
    const canvas = document.getElementById("gb");
  canvas.addEventListener("click", () => {
    if (window._gb && _gb.resumeAudio) _gb.resumeAudio();
  });
</script>




</body>
</html>
